# SmartCalc

SmartCalc — безопасный калькулятор выражений на Python с собственным лексером, Pratt-парсером и ядром вычислений. Инструмент работает интерактивно, исполняет сценарии `.calc`, строит графики и упрощает выражения. Дополнительно доступны веб-интерфейс и Python API для встраивания.

## Основные возможности
- Pratt-парсер с построением AST: числа, присваивания, унарные и бинарные операции (`+`, `-`, `*`, `/`, `//`, `%`, `**`), вызов функций.
- Безопасные константы (`pi`, `e`, `tau`, `phi`) и функции (`abs`, `max`, `min`, `round`, тригонометрические и гиперболические функции, `log`).
- Команда `plot` с адаптивной дискретизацией, отображением графика в браузере и экспортом в CSV/PNG/SVG.
- Команда `simplify` на базе SymPy: алгебраическое упрощение с учетом текущих переменных и констант.
- Сохранение состояния переменных между командами в REPL, при запуске файлов и во фронтенде SmartCalc Web.
- Gradio-приложение SmartCalc Web с историей вычислений, повторным запуском и очисткой сеанса.
- Python API (`tokenize`, `parse`, `eval_expr`, `simplify_expr`) для интеграции в тесты и сторонние сервисы.

## Требования
- Python 3.9 или новее.
- Основные зависимости устанавливаются вместе с пакетом (`colorama`, `numpy`, `plotly`, `kaleido`, `sympy`).
- Для запуска SmartCalc Web необходимо вручную установить `gradio`.

## Установка
1. Создайте виртуальное окружение (опционально):
   ```bash
   python -m venv .venv
   source .venv/bin/activate        # Linux/macOS
   .\.venv\Scripts\activate      # Windows PowerShell
   ```
2. Установите пакет в режиме разработки:
   ```bash
   pip install -e .
   ```
3. Для веб-интерфейса поставьте Gradio:
   ```bash
   pip install gradio
   ```

## Использование CLI
После установки доступна консольная команда `smartcalc`:
```bash
smartcalc
```
Альтернативно можно запустить модуль напрямую:
```bash
python -m smartcalc.cli
```

### Базовый REPL
REPL хранит состояние переменных между запросами:
```
> a = 10
10
> sin(pi / 6) * a
5
> simplify 2*a + 4*a
60
```
`Ctrl+C` завершает сеанс, пустая строка — тоже.

### Выполнение сценариев
Передайте путь к `.calc` файлу:
```bash
smartcalc -f tests/data/sample.calc
```
Итоги команд будут напечатаны в стандартный вывод. Ошибки сопровождаются номером строки.

### Команда `plot`
Синтаксис: `plot [имя[(переменная)]] = выражение [from A to B] [target csv|png|svg]`.

Примеры:
```
plot sin(x) from -2*pi to 2*pi
plot y = sqrt(x) target csv
plot f(t) = exp(-t) * sin(t) from -8 to 8 target png
```
Особенности:
- Если переменная не указана, выбирается первая встреченная, иначе используется `x`.
- `from ... to ...` задает область, по умолчанию `[-10, 10]`.
- Графики сохраняются в каталог `plots/plot-<переменная>-<timestamp>.<расширение>`. Для PNG/SVG требуется установленный Kaleido.
- Без `target` график откроется в браузере (если поддерживается окружением).

### Команда `simplify`
Синтаксис: `simplify выражение`.
- Поддерживаются те же операции и функции, что и в вычислениях (`sin`, `cos`, `tan`, `log`, `sqrt`, `abs`, `max`, `min`, `round`, `sinh`, `cosh`, `tanh`, `asin`, `acos`, `atan`).
- Текущие значения переменных и пользовательские константы учитываются при упрощении.
- При использовании неизвестных функций либо неподдерживаемых операторов будет выброшена ошибка `SmartCalcError`.

Пример:
```
> a = 2
2
> simplify (a**2 - 1)/(a - 1)
a + 1
```

## Python API
Пакет `smartcalc` предоставляет функции верхнего уровня:
```python
from smartcalc import api

tokens = api.tokenize("2 * (3 + 4)")
ast = api.parse("simplify sin(x)**2 + cos(x)**2")
value = api.eval_expr("round(sin(pi / 4), 2)")
simplified = api.simplify_expr("simplify (x**2 - 1)/(x - 1)")
```
`eval_expr` и `simplify_expr` принимают опциональные словари `constants` и `variables`, что позволяет интегрировать SmartCalc в собственные приложения.

## SmartCalc Web
Для запуска веб-интерфейса Gradio:
```bash
pip install gradio  # если еще не установлен
python -m smartcalc_web.app
```
Интерфейс предоставляет:
- ввод выражений с мгновенной выдачей результата;
- историю вычислений с повторным запуском и защитой от случайных дублей;
- очистку сеанса одной кнопкой.

## Тестирование
Запустите полный набор тестов:
```bash
pytest
```
Тесты покрывают ядро калькулятора, построение графиков, упрощение выражений и коллбеки веб-приложения. Для сценариев, связанных с графикой и вебом, должны быть установлены `plotly`, `kaleido` и `gradio`.

## Структура репозитория
- `smartcalc/` — ядро CLI и API.
- `smartcalc_web/` — Gradio-приложение.
- `tests/` — тесты Pytest и примеры `.calc`.
- `README.md`, `CODE_GUIDELINES.md` — документация.
