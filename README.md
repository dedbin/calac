# SmartCalc

SmartCalc — безопасный калькулятор выражений с собственным лексером, Pratt-парсером и строгим рантаймом. Он поддерживает числовые константы, ограниченный набор математических функций, присваивания, которые живут в пределах одной сессии, а также команду `plot` с адаптивной выборкой точек.

## Ключевые возможности
- Pratt-парсер и компактное AST (числа, идентификаторы, унарные/бинарные операции, вызовы, присваивания, графики).
- Детеминированный вычислитель, который никогда не исполняет произвольный Python-код.
- Консольный REPL и запуск `.calc`-файлов с развёрнутыми диагностическими сообщениями.
- Дополнительный интерфейс на Gradio для быстрой проверки выражений.
- Команда `plot`, строящая кривые через Plotly (интерактивно) и умеющая сохранять данные/изображения в CSV, PNG и SVG.

## Установка
1. Убедитесь, что установлен Python 3.9 или новее.
2. Создайте виртуальное окружение: `python -m venv .venv` и активируйте его.
3. Установите проект в editable-режиме:
   ```bash
   pip install -e .
   ```
   Зависимости Plotly и Kaleido подтянутся автоматически. При необходимости их можно добавить вручную: `pip install plotly kaleido`.

## Запуск из консоли
Интерактивный режим:
```bash
python -m smartcalc.cli
```

Выполнение скрипта (по одному выражению на строку, `#` — комментарий):
```bash
python -m smartcalc.cli -f tests/data/sample.calc
```

Пример диалога:
```
> x = 10
10
> sin(pi / 2)
1
```

### Команда plot
Команда `plot` вводится на уровне выражений REPL/скрипта; внутри арифметики она не допускается.
```
plot sin(x) from -2*pi to 2*pi
plot y = sqrt(x) target csv
plot f(t) = exp(-t) * sin(t) from -8 to 8 target png
```
Правила:
- **Синтаксис** — `plot [метка] [(переменная)] = выражение [from a to b] [target png|svg|csv]`. Часть до `=` опциональна. Если её нет, переменная определяется автоматически (по умолчанию `x`), а легенда принимает вид `f(x)`.
- **Диапазон** — без блока `from ... to ...` используется промежуток `[-10, 10]`. Границы можно задавать выражениями (например, `-2*pi`). Точки, в которых выражение не определено (`sqrt` на отрицательных, полюса и т. п.), пропускаются.
- **Выборка** — сначала берётся 128 точек, затем шаг удваивается до 4096, пока кривая не станет достаточно «плавной».
- **Вывод** — без `target` график открывается в браузере. С `target csv|png|svg` данные или изображение сохраняются в каталоге `./plots/plot-<переменная>-<timestamp>.<расширение>`, путь выводится в консоль. Для PNG/SVG нужен движок Kaleido.

## Веб-интерфейс
Gradio-интерфейс повторяет возможности CLI для числовых выражений. Команды `plot` там пока не поддерживаются — пользователь получает понятное сообщение с просьбой перейти в консоль.

## Тесты
Полный прогон тестов:
```bash
pytest
```
Тесты построения графиков автоматически пропускаются, если Plotly (или Kaleido для экспорта изображений) недоступны.

## Краткие рекомендации по разработке
- Следуйте PEP 8/PEP 257 и пишите максимально ясный код.
- Любые изменения синтаксиса сопровождайте обновлением лексера, парсера, вычислителя и тестов.
- Все пользовательские сообщения должны быть на русском языке.
- Новое поведение должно сопровождаться тестами (см. `tests/`).
- Документируйте изменения в README и CODE_GUIDELINES.
