# Руководство по коду SmartCalc

Эти рекомендации помогают поддерживать единый стиль и поведение проекта.

## Окружение
- Используйте Python 3.9 или новее.
- Создавайте виртуальное окружение (`python -m venv .venv`) и устанавливайте зависимости командой `pip install -e .`.
- Все новые зависимости фиксируйте в `pyproject.toml` и упоминайте в README.

## Структура модулей
- `smartcalc/tokens.py` — типы токенов и список ключевых слов.
- `smartcalc/lexer.py` — лексер без побочных эффектов.
- `smartcalc/parser.py` — Pratt-парсер, теперь умеет разбирать `PlotCommand`.
- `smartcalc/astnodes.py` — dataclass-описания узлов AST.
- `smartcalc/evaluator.py` — безопасное вычисление AST (никакого `eval` и глобальных побочных эффектов).
- `smartcalc/plotting.py` — адаптивная выборка, построение графиков Plotly, экспорт в файлы.
- `smartcalc/cli.py` — REPL и запуск скриптов; ошибки печатаются человекочитаемо.
- `smartcalc_web/app.py` — интерфейс на Gradio; команды `plot` отклоняются с дружественным текстом.

## Стиль
- Соблюдайте PEP 8/PEP 257. Комментарии используйте только для пояснения замысла.
- Не смешивайте анализ AST с вводом-выводом.
- Добавляете новый узел AST — обновляйте лексер, парсер, вычислитель и тесты одним коммитом.
- Все пользовательские сообщения и документация — на русском языке.

## Особенности plot
- Клонируйте состояние вычислителя перед выборкой, чтобы не портить переменные пользователя.
- Недопустимые точки заменяйте на `None` — Plotly разорвёт линию автоматически.
- Константы `_BASE_SAMPLE_COUNT`, `_MAX_SAMPLE_COUNT`, `_SLOPE_THRESHOLD` держите в одном месте и при изменениях обновляйте тесты.
- Экспорт в PNG/SVG возможен только при наличии Kaleido; в противном случае выбрасывайте понятный `EvalError`.
- CSV сохраняйте в `./plots/`, перед записью создавайте каталог.

## Тестирование
- Все тесты — pytest. Новое поведение → новый тест.
- В `tests/test_plotting.py` предусмотрены скипы: при отсутствии Plotly/Kaleido будет понятное сообщение.
- Для float-сравнений используйте `pytest.approx`.
- Не шарьте изменяемые состояния между тестами.

## Обработка ошибок
- Все пользовательские исключения должны наследовать `SmartCalcError`.
- Сообщения об ошибках формируйте на русском, без escape-последовательностей ANSI (UI сам решит, как их стилизовать).
- В CLI выводите ошибки через `_emit_error`, без traceback'ов.

## Рабочий процесс
- Один логический шаг — один коммит. Именуйте ветки по типу `feature/plot-command`.
- Перед PR гоняйте `pytest`. Дополнительные проверки (экспорт графиков и т. п.) описывайте в описании PR.
- Любое изменение синтаксиса или публичных API сопровождайте обновлением README и код-стайла.

Спасибо, что поддерживаете SmartCalc аккуратным и понятным!
