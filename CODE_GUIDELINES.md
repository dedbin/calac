# Руководство по разработке SmartCalc

## Назначение документа
Этот файл помогает новым участникам быстро войти в проект и сохранить единые стандарты разработки. Здесь описаны архитектура, требования к окружению, стилистика кода, процессы тестирования и правила совместной работы.

## Быстрый старт
- Установите Python 3.9 или новее.
- Создайте виртуальное окружение (`python -m venv .venv`, затем `source .venv/bin/activate` или `Scripts\activate`).
- Установите проект в режиме разработки: `pip install -e .` — так обновления пакета автоматически подтянутся в среду.
- Запустите базовые тесты: `pytest`. Все новые коммиты должны проходить этот набор.

## Архитектура и ключевые модули
- `smartcalc/lexer.py` — преобразует строку во входные токены. Новые токены добавляйте максимально локально, избегайте «магических» проверок за пределами лексера.
- `smartcalc/parser.py` — Pratt-парсер, собирающий AST, полагаясь на таблицу приоритетов из `precedence.py`.
- `smartcalc/astnodes.py` — определения узлов AST. Расширяйте аккуратно, не смешивайте разные типы ответственности в одном узле.
- `smartcalc/evaluator.py` — вычисляет значения AST, используя таблицы констант и допустимых операций.
- `smartcalc/api.py` — единственная точка входа для внешних потребителей (`tokenize`, `parse`, `eval_expr`). Любые изменения конвейера должны корректно отражаться здесь.
- `smartcalc/cli.py` — REPL и запуск вычислений из файлов; ориентируйтесь на дружелюбный UX и аккуратную работу с stderr/stdout.
- `tests/` — покрытие pytest; используйте `tests/data/` для текстовых входов.

## Стиль кода
- Следуйте PEP 8 и PEP 257. Длинные строки предпочитайте разбивать, как в `parser.py`.
- Все новые публичные функции и методы снабжайте аннотациями типов. При работе с AST используйте обобщённые типы (`SmartCalcAST`, `Token` и т.д.)
- Импорты группируйте: стандартная библиотека → сторонние пакеты → модули проекта. Оставляйте одну пустую строку между группами.
- Старайтесь писать чистые функции без побочных эффектов. Для состояния используйте объекты (как `Parser` или `Evaluator`).
- Документируйте сложные места короткими комментариями или докстрингами. Избегайте избыточных комментариев «по очевидному».
- Не используйте глобальные синглтоны. Если нужно поделиться конфигурацией, передайте её аргументом конструктора.

## Обработка ошибок и сообщения
- Все пользовательские ошибки наследуются от `SmartCalcError` (`LexError`, `ParseError`, `EvalError`, `NameResolutionError`).
- Сообщения об ошибках должны быть понятны пользователю, на русском языке, без жаргона.
- Для выделения проблемного места используйте `make_caret_message` из `smartcalc/errors.py`.
- В CLI избегайте вывода tracebacks, ловите исключения и выводите человеко-читаемые сообщения через `_emit_error`.
- Используйте «мягкие» зависимости: если `colorama` недоступен, функциональность без цвета должна работать (см. fallback в `errors.py` и `cli.py`).

## Расширение парсера и AST
- Любые новые операторы обязательно добавляйте в `tokens.py` (распознавание), `precedence.py` (приоритет и ассоциативность) и `parser.py` (nud/led-обработка).
- При вводе новых узлов AST добавляйте их в `astnodes.py`, пишите тесты на парсинг и вычисление.
- Сохраняйте принцип single-source-of-truth: таблица приоритетов должна лежать в одном месте, а не копироваться по коду.
- Покрывайте негативные сценарии: незакрытые скобки, неожиданные символы, ошибки при приведении типов.

## Тестирование
- Используем pytest. Названия тестов объясняют поведение (пример: `test_power_right_assoc`).
- Для чисел с плавающей точкой сравнивайте через `pytest.approx`.
- Добавляйте параметризованные тесты (`@pytest.mark.parametrize`) для похожих сценариев.
- Минимальный уровень покрытия — все новые функции и ветки. Если логика сложная, добавляйте property-based тесты (например, с `hypothesis`) в отдельные файлы, но договоритесь об этом заранее.
- Перед PR обязательно прогоняйте `pytest` локально. Если добавлены интеграционные сценарии, приложите инструкцию как их повторить.

## Работа с документацией и примерами
- README должен отражать текущее состояние функций CLI и API. При изменениях интерфейсов обновляйте разделы команд и примеров.
- Файл `tests/data/sample.calc` служит эталонным примером. Дополняйте его новыми выражениями, если они улучшают понимание возможностей.
- При добавлении пользовательских функций или констант описывайте их в `constants.py` и документации.

## Стандартный процесс разработки
- Для задач заводите ветки вида `feature/<краткое-описание>` или `fix/<краткое-описание>`.
- Коммиты должны быть атомарными, с англоязычными заголовками формата `feat: add call node for user functions`.
- Перед пушем: `pytest`, проверка форматирования (например, `python -m compileall smartcalc`). #not implemented
- В PR описывайте: цель, ключевые изменения, влияние на пользователи, риски и чеклист проверок.
- Отвечайте на комментарии ревьюеров в течение рабочего дня, отмечайте выполненные пункты.

## Практики качества
- Поддерживайте чистоту репозитория: не коммитьте артефакты, используйте `.gitignore`.
- Временный код или скрипты помещайте в `scripts/` или разделяйте препроцессорами `# pragma: no cover` только там, где действительно нужна защита от покрытия.
- При работе на Windows сверяйте вывод CLI (учитываем использование `colorama.just_fix_windows_console`).
- Если добавляете внешние зависимости, обсудите командой и закрепите диапазон версий в `pyproject.toml`.

## Коммуникация и чек-лист перед слиянием
- Убедитесь, что:
  - [ ] Тесты проходят.
  - [ ] Документация и примеры обновлены.
  - [ ] Сообщения об ошибках понятны и проверены вручную.
  - [ ] Нет лишних отладочных принтов/комментариев.
  - [ ] branch не содержит merge-конфликтов.
- При сомнениях задавайте вопросы в общем канале или в комментариях к задаче.

Добро пожаловать в команду SmartCalc!
