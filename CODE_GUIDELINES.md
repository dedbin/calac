# Правила работы с кодом SmartCalc

Документ описывает договоренности по разработке и структуру проекта. Соблюдение этих правил помогает поддерживать согласованное поведение CLI, веб-интерфейса и Python API.

## Архитектура проекта
- `smartcalc/api.py` — точка входа Python API (`tokenize`, `parse`, `eval_expr`, `simplify_expr`).
- `smartcalc/tokens.py` — описание токенов и ключевых слов лексера.
- `smartcalc/lexer.py` — лексический анализатор, отвечающий за поток токенов.
- `smartcalc/parser.py` — Pratt-парсер, поддерживает присваивания, `plot`, `simplify`.
- `smartcalc/astnodes.py` — структуры AST (числа, вызовы, операции, `PlotCommand`, `SimplifyCommand`).
- `smartcalc/evaluator.py` — безопасное вычисление выражений, хранение переменных, валидация функций.
- `smartcalc/simplify.py` — адаптер SymPy для команды `simplify`, синхронизированный с возможностями `Evaluator`.
- `smartcalc/plotting.py` — построение графиков, адаптивная выборка точек, экспорт в CSV/PNG/SVG.
- `smartcalc/constants.py` — базовые константы и настройки округления.
- `smartcalc/cli.py` — REPL, запуск файлов, цветовой вывод ошибок.
- `smartcalc_web/app.py` — Gradio-интерфейс, история вычислений и коллбеки.
- `tests/` — модульные и интеграционные тесты Pytest.

## Договоренности по разработке
- Соблюдаем PEP 8, PEP 257 и используем аннотации типов на публичных функциях.
- Пользовательские ошибки наследуем от `SmartCalcError` (либо существующих `EvalError`, `NameResolutionError`). Сообщения формируем по-русски.
- Цвет и ANSI-коды добавляются только в CLI-слое (`smartcalc/cli.py`); внутренняя логика возвращает чистые строки.
- Добавляя новые операторы или функции, обновляем `SAFE_FUNCS`, `parser`, тесты и документацию.
- Расширение `simplify` требует синхронизации со списком доступных функций (`_SYMPY_FUNCTIONS`) и тестов `test_simplify.py`.
- Изменения в `plotting` должны сохранять адаптивный отбор (`_BASE_SAMPLE_COUNT`, `_MAX_SAMPLE_COUNT`, `_SLOPE_THRESHOLD`) и корректно обрабатывать целевые форматы.
- При изменении CLI/Web убедитесь, что поведение REPL/истории неизменно или документировано в README.

## Работа с зависимостями
- Основные зависимости (`colorama`, `numpy`, `plotly`, `kaleido`, `sympy`) перечислены в `pyproject.toml`. Новые библиотеки обсуждаем заранее.
- SmartCalc Web требует `gradio`, устанавливаемого вручную; дополнительные инструменты фиксируем в README и requirements.
- Для вспомогательных утилит разработки используем отдельные extras, чтобы не усложнять установку конечным пользователям.

## Тестирование
- Запускаем `pytest` перед публикацией изменений.
- Ключевые файлы: `tests/test_core.py`, `tests/test_functions.py`, `tests/test_plotting.py`, `tests/test_simplify.py`, `tests/test_web_app.py`.
- Тесты для графиков зависят от `plotly` и `kaleido`, веб-тесты — от `gradio`. Проверяйте наличие зависимостей перед прогонами CI/локально.
- Новые возможности сопровождаем тестами с понятными исходными данными (`tests/data/`).

## Документация и UX
- Обновляем `README.md` и `CODE_GUIDELINES.md` при изменении функциональности, CLI-флагов, зависимостей или пользовательских сценариев.
- Примеры `.calc` файлов содержат комментарии через `#`, поясняющие контекст.
- Ошибки и предупреждения формулируем кратко и по делу, избегаем технических деталей трассировки в пользовательском выводе.

## Качество кода
- Разделяем вычислительную логику и ввод/вывод. Модули не должны печатать данные напрямую, кроме CLI и Gradio-слоя.
- Перед дорогими вычислениями валидируем входные данные и возвращаем информативные ошибки.
- Поддерживаем фукнциональный паритет между CLI, API и веб-интерфейсом: добавляя возможность в одном слое, проверяем остальные.
